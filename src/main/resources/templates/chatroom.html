<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta th:remove="tag" th:include="fragements/header::header(title='ç›´æ’­é—´')">
    <style>

        .send-message {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>

<body>

<div id="Page" v-cloak>
    <div class="chatroom">
        <div v-for="(message,index) in messages" :key="index" class="weui-flex">
            <van-image width="30" height="30" :src="message.head_img_url"></van-image>
            <div>{{message.nick_name+":"+message.message}}</div>
        </div>

        <van-cell-group class="send-message">
            <van-field v-model="inputMessage" center>
                <van-button slot="button" size="small" type="primary" @click="send">å‘é€</van-button>
            </van-field>
        </van-cell-group>
    </div>


</div>
</div>
</body>

<footer>

    <div th:remove="tag" th:include="fragements/footer::footer"></div>
    <script th:src="@{/scripts/sockjs.min.js}"></script>
    <script th:src="@{/scripts/stomp.min.js}"></script>

    <script type="text/javascript" th:inline="javascript">
        (function (global) {
            var roomUid=[[${roomUid}]];
            var user={
                user_uid:[[${userUid}]],
                nick_name: 'å®‰å­',
                head_img_url: 'https://s1.ouyada.com/20200225/noInviteRecord.svg'
            }

            class Message{
                constructor(message){
                    this.roomUid=roomUid;
                    this.userUid=user.user_uid;
                    this.nickName=user.nick_name;
                    this.headImgUrl=user.head_img_url;
                    this.message=message;
                    return this;
                }
            }


            new Vue({
                el: '#Page',
                data: {
                    roomUid:[[${roomUid}]],
                    messages: [],
                    inputMessage: "",
                    stompClient: null,
                    user:user
                },
                mounted() {
                    var _this = this;
                    var socket = new SockJS('/start/connect');
                    _this.stompClient = Stomp.over(socket);
                    _this.stompClient.connect({
                        username:_this.user.user_uid,
                        password:_this.user.user_uid,
                        roomUid:_this.roomUid
                    }, function (frame) {
                        if(frame.command!='CONNECTED'){
                            console.log("è¿æ¥å¤±è´¥,ç½‘ç»œç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
                            return;
                        }
                        _this.sendMessage("è¿›å…¥ç›´æ’­é—´");
                        //è¿”å›ä¿¡æ¯é‡Œå¯ä»¥åŠ ä¸€æ¡ç›´æ’­é—´å½“å‰äººæ•°
                        _this.stompClient.subscribe('/user/'+_this.user.user_uid+'/queue/shouts', function (response) {
                            _this.inputMessage="";
                            _this.messages.push(JSON.parse(response.body));
                        },function (err) {
                            //è¿æ¥å¤±è´¥ï¼Œå¯ä»¥ğŸ”™ä¸Šä¸€é¡µ
                            console.log("err: " + err);
                        })

                    });
                },
                destroyed: function () {
                    this.stompClient.disconnect(
                        function () {
                          //å¯ä»¥è®°å½•ç¦»å¼€äººæ•°ï¼Œå‘é€ç¦»å¼€ä¿¡æ¯
                            alert("æ–­å¼€è¿æ¥");
                        });
                },
                methods: {
                    send:function(){
                        this.sendMessage(this.inputMessage);
                    },
                    sendMessage: function (messsage) {
                        var message=new Message(messsage);
                        this.stompClient.send("/app/singleShout", {}, JSON.stringify(message));
                    }
                }
            });
        })(window);

    </script>

</footer>


</html>




